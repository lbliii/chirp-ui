{#- chirp-ui: Form field macros
    Extended field macros with BEM styling. These complement (and can replace)
    Chirp's built-in form macros from "chirp/forms".

    Internal: field_wrapper provides label, hint, error display. Standard fields
    use it; checkbox/toggle/radio/range/input_group have custom layouts.
-#}

{# Shared wrapper: label, slot (control), hint, errors. modifier adds chirpui-field--X. #}
{% def field_wrapper(name, label=none, errors=none, required=false, hint=none, modifier="") %}
<div class="chirpui-field{{ " chirpui-field--" ~ modifier if modifier else "" }}{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    {% if label %}
        <label class="chirpui-field__label" for="{{ name }}">
            {{ label }}{% if required %} <span class="chirpui-field__required" aria-hidden="true">*</span>{% end %}
        </label>
    {% end %}
    {% slot %}
    {% if hint and not (errors and errors | field_errors(name)) %}
        <span class="chirpui-field__hint">{{ hint }}</span>
    {% end %}
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

    Usage:
        from "chirpui/forms.html" import text_field, textarea_field, select_field

        text_field("title", value=form.title, label="Title",
                   errors=errors, required=true)
        textarea_field("description", value=form.description,
                       label="Description", rows=6)
        select_field("status", options=statuses, selected=form.status,
                     label="Status")
        checkbox_field("active", checked=form.active, label="Active")
        toggle_field("notifications", checked=true, label="Enable notifications")
        radio_field("plan", options=plans, selected=form.plan, label="Plan")
        file_field("avatar", label="Avatar", accept="image/*")
        date_field("birthday", value=form.birthday, label="Birthday")
        range_field("volume", value=50, min=0, max=100, label="Volume", show_value=true)
        hidden_field("id", value=form.id)

    Note: The field_errors filter is provided by Chirp. When using chirp-ui
    without Chirp, define your own field_errors filter or pass errors=none.
-#}

{# Text input with label and error display #}
{% def text_field(name, value="", label=none, errors=none, type="text",
                  required=false, placeholder="", hint=none, attrs="") %}
{% call field_wrapper(name, label, errors, required, hint) %}
<input class="chirpui-field__input"
       type="{{ type }}" id="{{ name }}" name="{{ name }}"
       value="{{ value }}"
       {% if required %}required{% end %}
       {% if placeholder %}placeholder="{{ placeholder }}"{% end %}
       {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}
       {{ attrs }}>
{% end %}
{% end %}

{# Textarea with label and error display #}
{% def textarea_field(name, value="", label=none, errors=none,
                      rows=4, required=false, placeholder="", hint=none) %}
{% call field_wrapper(name, label, errors, required, hint) %}
<textarea class="chirpui-field__input"
          id="{{ name }}" name="{{ name }}" rows="{{ rows }}"
          {% if required %}required{% end %}
          {% if placeholder %}placeholder="{{ placeholder }}"{% end %}
          {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>{{ value }}</textarea>
{% end %}
{% end %}

{# Select dropdown with label and error display #}
{% def select_field(name, options, selected="", label=none, errors=none,
                    required=false, hint=none) %}
{% call field_wrapper(name, label, errors, required, hint) %}
<select class="chirpui-field__input"
        id="{{ name }}" name="{{ name }}"
        {% if required %}required{% end %}
        {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
    {% for opt in options %}
        <option value="{{ opt.value }}"
                {% if opt.value == selected %}selected{% end %}>
            {{ opt.label }}
        </option>
    {% end %}
</select>
{% end %}
{% end %}

{# Checkbox with label #}
{% def checkbox_field(name, checked=false, label=none, errors=none) %}
<div class="chirpui-field chirpui-field--checkbox{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    <label class="chirpui-field__label chirpui-field__label--inline">
        <input class="chirpui-field__checkbox"
               type="checkbox" id="{{ name }}" name="{{ name }}"
               {% if checked %}checked{% end %}>
        {{ label if label else name }}
    </label>
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

{# Toggle (switch-style checkbox) #}
{% def toggle_field(name, checked=false, label=none, errors=none) %}
<div class="chirpui-field chirpui-field--toggle{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    <label class="chirpui-field__label chirpui-field__label--inline chirpui-toggle-wrap">
        <input class="chirpui-toggle chirpui-visually-hidden"
               type="checkbox" id="{{ name }}" name="{{ name }}"
               {% if checked %}checked{% end %}
               {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
        <span class="chirpui-toggle__track" aria-hidden="true"></span>
        <span class="chirpui-toggle__label">{{ label if label else name }}</span>
    </label>
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

{# Radio group with label and error display #}
{% def radio_field(name, options, selected="", label=none, errors=none,
                   required=false, hint=none, layout="vertical") %}
<fieldset class="chirpui-field chirpui-field--radio chirpui-field--radio-{{ layout }}{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    {% if label %}
        <legend class="chirpui-field__label">
            {{ label }}{% if required %} <span class="chirpui-field__required" aria-hidden="true">*</span>{% end %}
        </legend>
    {% end %}
    <div class="chirpui-field__radio-group">
        {% for opt in options %}
        <label class="chirpui-field__radio-option">
            <input class="chirpui-field__input"
                   type="radio" name="{{ name }}" value="{{ opt.value }}"
                   {% if opt.value == selected %}checked{% end %}
                   {% if required %}required{% end %}
                   {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
            <span class="chirpui-field__radio-label">{{ opt.label }}</span>
        </label>
        {% end %}
    </div>
    {% if hint and not (errors and errors | field_errors(name)) %}
        <span class="chirpui-field__hint">{{ hint }}</span>
    {% end %}
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</fieldset>
{% end %}

{# File input with label and error display #}
{% def file_field(name, label=none, errors=none, accept="", multiple=false,
                  required=false, hint=none) %}
{% call field_wrapper(name, label, errors, required, hint, modifier="file") %}
<input class="chirpui-field__file"
       type="file" id="{{ name }}" name="{{ name }}"
       {% if accept %}accept="{{ accept }}"{% end %}
       {% if multiple %}multiple{% end %}
       {% if required %}required{% end %}
       {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
{% end %}
{% end %}

{# Date input with label and error display #}
{% def date_field(name, value="", label=none, errors=none, required=false,
                  min=none, max=none, hint=none) %}
{% call field_wrapper(name, label, errors, required, hint) %}
<input class="chirpui-field__input"
       type="date" id="{{ name }}" name="{{ name }}" value="{{ value }}"
       {% if required %}required{% end %}
       {% if min %}min="{{ min }}"{% end %}
       {% if max %}max="{{ max }}"{% end %}
       {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
{% end %}
{% end %}

{# Range slider with label and error display #}
{% def range_field(name, value=50, min=0, max=100, step=1, label=none,
                   errors=none, hint=none, show_value=false) %}
<div class="chirpui-field chirpui-field--range{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    {% if label or show_value %}
    <div class="chirpui-field__range-header">
        {% if label %}
            <label class="chirpui-field__label" for="{{ name }}">{{ label }}</label>
        {% end %}
        {% if show_value %}
            <output class="chirpui-field__range-value" for="{{ name }}">{{ value }}</output>
        {% end %}
    </div>
    {% end %}
    <input class="chirpui-field__range"
           type="range" id="{{ name }}" name="{{ name }}"
           value="{{ value }}" min="{{ min }}" max="{{ max }}" step="{{ step }}"
           {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
    {% if hint and not (errors and errors | field_errors(name)) %}
        <span class="chirpui-field__hint">{{ hint }}</span>
    {% end %}
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

{# Input with prefix/suffix. Use prefix/suffix params for text, or slot prefix/suffix for custom content (icons, etc). #}
{% def input_group(name, prefix=none, suffix=none, value="", label=none,
                   errors=none, type="text", required=false, placeholder="",
                   hint=none, attrs="") %}
<div class="chirpui-field chirpui-field--input-group{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    {% if label %}
        <label class="chirpui-field__label" for="{{ name }}">
            {{ label }}{% if required %} <span class="chirpui-field__required" aria-hidden="true">*</span>{% end %}
        </label>
    {% end %}
    <div class="chirpui-input-group">
        {% if prefix %}
        <span class="chirpui-input-group__prefix">{{ prefix }}</span>
        {% else %}
        <span class="chirpui-input-group__prefix">{% slot prefix %}</span>
        {% end %}
        <input class="chirpui-input-group__input"
               type="{{ type }}" id="{{ name }}" name="{{ name }}"
               value="{{ value }}"
               {% if required %}required{% end %}
               {% if placeholder %}placeholder="{{ placeholder }}"{% end %}
               {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}
               {{ attrs }}>
        {% if suffix %}
        <span class="chirpui-input-group__suffix">{{ suffix }}</span>
        {% else %}
        <span class="chirpui-input-group__suffix">{% slot suffix %}</span>
        {% end %}
    </div>
    {% if hint and not (errors and errors | field_errors(name)) %}
        <span class="chirpui-field__hint">{{ hint }}</span>
    {% end %}
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

{# Multi-select dropdown with label and error display #}
{% def multi_select_field(name, options, selected=[], label=none, errors=none,
                          required=false, hint=none, size=4) %}
{% call field_wrapper(name, label, errors, required, hint) %}
<select class="chirpui-field__input chirpui-field__input--multi"
        id="{{ name }}" name="{{ name }}" multiple size="{{ size }}"
        {% if required %}required{% end %}
        {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}>
    {% for opt in options %}
        <option value="{{ opt.value }}"
                {% if opt.value in selected %}selected{% end %}>
            {{ opt.label }}
        </option>
    {% end %}
</select>
{% end %}
{% end %}

{# Search input with optional htmx debounced search #}
{% def search_field(name, value="", label=none, search_url=none, search_target=none,
                    search_trigger="keyup changed delay:300ms", search_include=none,
                    placeholder="Search...", errors=none, attrs="") %}
{% set search_attrs = ('hx-get="' ~ search_url ~ '" hx-trigger="' ~ search_trigger ~ '" hx-target="' ~ search_target ~ '" hx-swap="innerHTML"' ~ (' hx-include="' ~ search_include ~ '"' if search_include else '')) if (search_url and search_target) else '' %}
<div class="chirpui-field{{ " chirpui-field--error" if errors and errors | field_errors(name) else "" }}">
    {% if label %}
        <label class="chirpui-field__label" for="{{ name }}">{{ label }}</label>
    {% end %}
    <input class="chirpui-field__input"
           type="search" id="{{ name }}" name="{{ name }}"
           value="{{ value }}"
           placeholder="{{ placeholder }}"
           {% if errors and errors | field_errors(name) %}aria-invalid="true"{% end %}
           {{ search_attrs | safe }} {{ attrs }}>
    {% if errors %}
        {% for msg in errors | field_errors(name) %}
            <span class="chirpui-field__error">{{ msg }}</span>
        {% end %}
    {% end %}
</div>
{% end %}

{# Hidden field #}
{% def hidden_field(name, value="") %}
<input type="hidden" name="{{ name }}" value="{{ value }}">
{% end %}

{# Form actions â€” submit/cancel button row. Use align="end" for right-aligned. #}
{% def form_actions(align="start", cls="") %}
{% set align_class = " chirpui-form-actions--end" if align == "end" else "" %}
<div class="chirpui-form-actions{{ align_class }}{{ " " ~ cls if cls else "" }}">
    {% slot %}
</div>
{% end %}
